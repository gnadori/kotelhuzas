<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vita Kötélhúzás</title>
    <style>
        :root { --blue: #007bff; --red: #dc3545; --light-blue: #e6f2ff; --light-red: #ffe6e6; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { width: 100%; max-width: 800px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 25px; text-align: center; }
        h1, h2, h3 { color: #1c1e21; }
        button { background-color: var(--blue); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        button:hover { background-color: #0056b3; }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        input[type="text"], textarea { width: calc(100% - 24px); padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; margin: 5px 0 15px 0; }
        textarea { min-height: 100px; resize: vertical; }
        .hidden { display: none !important; }
        label { display: block; text-align: left; font-weight: bold; margin-bottom: 2px; }
        #join-screen { max-width: 450px; }
        #game-header, #debate-topic-container, .tug-of-war-container, #rounds-container, #input-area { text-align: center; }
        #debate-info { font-size: 14px; color: #666; }
        #debate-code-display { font-weight: bold; background: #eee; padding: 2px 6px; border-radius: 4px; }
        .admin-badge { background-color: #ffc107; color: #333; font-size: 12px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 5px; }
        #debate-topic-container { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 25px; text-align: left; border-left: 5px solid var(--blue); }
        .positions { display: flex; justify-content: space-between; gap: 20px; }
        .position-box { flex: 1; }
        .position-box h4 { margin: 0 0 5px 0; padding-bottom: 5px; border-bottom: 2px solid; }
        .position-a h4 { color: var(--blue); border-color: var(--blue); }
        .position-b h4 { color: var(--red); border-color: var(--red); }
        .tug-of-war-container { display: flex; align-items: center; justify-content: space-between; margin: 25px 0; padding: 10px; background: linear-gradient(to right, var(--light-blue), var(--light-red)); border-radius: 8px; }
        .debater-name { font-weight: bold; font-size: 20px; }
        .name-a { color: var(--blue); } .name-b { color: var(--red); }
        .rope-track { flex-grow: 1; height: 8px; background-color: #ddd; margin: 0 20px; position: relative; border-radius: 4px; }
        #marker { width: 16px; height: 24px; background-color: #333; border-radius: 4px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 2px solid white; transition: transform 1s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .round { border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px; text-align: left; }
        .round-header { font-weight: bold; margin-bottom: 15px; font-size: 18px; color: #555; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .arguments { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .argument-box { padding: 15px; border-radius: 8px; min-height: 80px; }
        .argument-a { background-color: var(--light-blue); border-left: 4px solid var(--blue); }
        .argument-b { background-color: var(--light-red); border-left: 4px solid var(--red); }
        .argument-box h4 { margin-top: 0; }
        .voting-section { margin-top: 15px; display: flex; justify-content: space-around; align-items: center; }
    </style>
</head>
<body>
    <div class="container">
        <div id="join-screen">
            <h1>Vita Kötélhúzás</h1>
            <p>Csatlakozz a vitához a tanártól kapott kóddal.</p>
            <label for="join-code-input">Csatlakozási Kód</label>
            <input type="text" id="join-code-input" placeholder="Írd be a kapott kódot">
            <button id="join-btn">Csatlakozás</button>
        </div>
        <div id="game-screen" class="hidden">
            <div id="debate-topic-container">
                <h2 id="topic-display"></h2>
                <div class="positions">
                    <div class="position-box position-a"><h4>'A' álláspont</h4><p id="pos-a-display"></p></div>
                    <div class="position-box position-b"><h4>'B' álláspont</h4><p id="pos-b-display"></p></div>
                </div>
            </div>
            <div id="game-header">
                <h2 id="turn-indicator"></h2>
                <div id="debate-info">Vita kódja: <span id="debate-code-display"></span> | Szereped: <span id="user-role-display"></span><span id="admin-badge-display" class="hidden"><span class="admin-badge">ADMIN</span></span></div>
            </div>
            <div class="tug-of-war-container">
                <span class="debater-name name-a">A oldal (<span id="score-a">0</span>)</span>
                <div class="rope-track"><div id="marker"></div></div>
                <span class="debater-name name-b">(<span id="score-b">0</span>) B oldal</span>
            </div>
            <div id="rounds-container"></div>
            <div id="input-area"></div>
            <div id="winner-screen" class="hidden"></div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBGmSIw623DYSMyvULld3cg9NznPgdOawU",
          authDomain: "kotelhuzas-c552c.firebaseapp.com",
          databaseURL: "https://kotelhuzas-c552c-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "kotelhuzas-c552c",
          storageBucket: "kotelhuzas-c552c.appspot.com",
          messagingSenderId: "847078215867",
          appId: "1:847078215867:web:a0bca5d972d117d000599e",
          measurementId: "G-F9M0EJZ4GW"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const joinScreen=document.getElementById("join-screen"),gameScreen=document.getElementById("game-screen"),joinCodeInput=document.getElementById("join-code-input"),joinBtn=document.getElementById("join-btn"),topicDisplay=document.getElementById("topic-display"),posADisplay=document.getElementById("pos-a-display"),posBDisplay=document.getElementById("pos-b-display"),debateCodeDisplay=document.getElementById("debate-code-display"),userRoleDisplay=document.getElementById("user-role-display"),scoreADisplay=document.getElementById("score-a"),scoreBDisplay=document.getElementById("score-b"),marker=document.getElementById("marker"),turnIndicator=document.getElementById("turn-indicator"),roundsContainer=document.getElementById("rounds-container"),inputArea=document.getElementById("input-area"),winnerScreen=document.getElementById("winner-screen"),adminBadgeDisplay=document.getElementById("admin-badge-display");
        let currentDebateId=null,currentUserRole=null,dbRef=null,localState={};
        let userUid = sessionStorage.getItem('userUid');
        if (!userUid) {
            userUid = 'user_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('userUid', userUid);
        }
        joinBtn.addEventListener('click', joinDebate);
        async function joinDebate() {
            const enteredCode = joinCodeInput.value.trim().toUpperCase(); if (!enteredCode) { alert('Kérlek, adj meg egy csatlakozási kódot!'); return; }
            const mappingRef = db.ref('/codeMappings/' + enteredCode); const mappingSnapshot = await mappingRef.once('value');
            if (!mappingSnapshot.exists()) { alert('Érvénytelen kód!'); return; }
            const { debateId, role } = mappingSnapshot.val();
            const debateRef = db.ref('/debates/' + debateId); const debateSnapshot = await debateRef.once('value');
            if (!debateSnapshot.exists()) { alert('Hiba: A vita nem található!'); return; }
            const participants = debateSnapshot.val().participants || {};
            if ((role === 'A' || role === 'B') && participants[role]) { alert(`Ez a szerepkör ('${role}') már foglalt!`); return; }
            currentUserRole = role; currentDebateId = debateId; dbRef = debateRef;
            sessionStorage.setItem('debateId', currentDebateId); sessionStorage.setItem('userRole', currentUserRole);
            if (role === 'A' || role === 'B') { await db.ref(`debates/${currentDebateId}/participants/${role}`).set(true); }
            joinScreen.classList.add('hidden'); gameScreen.classList.remove('hidden'); listenForUpdates();
        }
        function listenForUpdates(){dbRef.on("value",t=>{if(!t.exists())return alert("A vitát törölték."),void location.reload();const e=t.val();"WAITING_FOR_PLAYERS"===e.gameState&&e.participants?.A&&e.participants?.B?(dbRef.update({gameState:"A_TURN",turn:"A"}),0):void(localState=e,updateUI(e))})}
        function updateUI(t){topicDisplay.textContent=t.topic,posADisplay.textContent=t.positionA,posBDisplay.textContent=t.positionB,debateCodeDisplay.textContent=currentDebateId,userRoleDisplay.textContent=currentUserRole,scoreADisplay.textContent=t.scoreA,scoreBDisplay.textContent=t.scoreB,userUid===t.adminUid&&adminBadgeDisplay.classList.remove("hidden");const e=(t.markerPosition-60)*(50/60);marker.style.transform=`translate(-50%, -50%) translateX(${e}%)`,roundsContainer.innerHTML="",t.rounds&&t.rounds.forEach((e,a)=>{const n=document.createElement("div");n.className="round";let o=e.winner?` - A kört nyerte: ${e.winner}`:"";const s=e.startingPlayer,r="A"===s?"B":"A",d=`<div class="argument-box argument-${s.toLowerCase()}"><h4>'${s}' érve:</h4><p>${e.startingArgument||"<i>Várakozás...</i>"}</p></div>`,c=`<div class="argument-box argument-${r.toLowerCase()}"><h4>'${r}' válasza:</h4><p>${e.respondingArgument||"<i>Várakozás...</i>"}</p></div>`;if(n.innerHTML=`<div class="round-header">${a+1}. Kör (Kezdő: ${s})${o}</div><div class="arguments">${"A"===s?d+c:c+d}</div>`,"VOTING"===t.gameState&&t.rounds.length-1===a){const o=document.createElement("div");o.className="voting-section";const s=userUid===t.adminUid,r=s?`(${(e.votesA||0)})`:"",d=s?`(${(e.votesB||0)})`:"",c=`voted_${currentDebateId}_${a}`,i=sessionStorage.getItem(c);o.innerHTML=`<span>Szavazz:</span><button class="vote-btn" onclick="castVote(${a}, 'A')" ${i?"disabled":""}>'A' érvére ${r}</button><button class="vote-btn" onclick="castVote(${a}, 'B')" ${i?"disabled":""}>'B' érvére ${d}</button>`,n.appendChild(o)}userUid===t.adminUid&&"VOTING"===t.gameState&&t.rounds.length-1===a&&(()=>{const t=document.createElement("button");t.textContent="Kör lezárása és eredmény (Admin)",t.style.marginTop="15px",t.onclick=()=>endRound(a),n.appendChild(t)})(),roundsContainer.prepend(n)}),inputArea.innerHTML="", "FINISHED"===t.gameState?(gameScreen.classList.add("hidden"),winnerScreen.classList.remove("hidden"),winnerScreen.innerHTML=`<h1>A játék véget ért!</h1><h2>A győztes: ${t.winner} oldal!</h2><button onclick="location.reload()">Új játék</button>`,dbRef.off(),0):"WAITING_FOR_PLAYERS"===t.gameState?(turnIndicator.textContent="Várakozás a vitázók csatlakozására...",inputArea.innerHTML='<div id="status-message">A vita elindul, amint \'A\' és \'B\' is csatlakozott.</div>'):t.turn===currentUserRole?(turnIndicator.textContent="Te következel!",inputArea.innerHTML=`<textarea id="argument-input" placeholder="${t.rounds&&t.rounds[t.rounds.length-1]&&t.rounds[t.rounds.length-1].startingArgument&&!t.rounds[t.rounds.length-1].respondingArgument?"Írd be a válaszod...":"Írd be az érvedet..."}"></textarea><button id="submit-argument-btn">Elküldés</button>`,document.getElementById("submit-argument-btn").onclick=submitArgument):"VOTING"===t.gameState?(turnIndicator.textContent="Szavazás!",inputArea.innerHTML='<div id="status-message">A közönség szavaz! Az admin lezárhatja a kört.</div>'):(turnIndicator.textContent=`Várakozás '${t.turn}' vitázóra...`,inputArea.innerHTML='<div id="status-message">Kis türelmet, amíg a másik fél megfogalmazza az érvét.</div>')}
        function submitArgument(){const t=document.getElementById("argument-input").value.trim();if(!t)return void alert("Az érv nem lehet üres!");const e={},a=localState.rounds?[...localState.rounds]:[],n=a.length>0?a[a.length-1]:null;n&&n.startingArgument&&!n.respondingArgument?(e[`/rounds/${a.length-1}/respondingArgument`]=t,e["/gameState"]="VOTING",e["/turn"]=null):(e[`/rounds/${a.length}`]={startingPlayer:localState.turn,startingArgument:t,votesA:0,votesB:0},e["/turn"]="A"===localState.turn?"B":"A",e["/gameState"]="A"===localState.turn?"B_TURN":"A_TURN"),dbRef.update(e)}
        function castVote(t,e){const a=`voted_${currentDebateId}_${t}`;if(sessionStorage.getItem(a))return void alert("Ebben a körben már szavaztál!");db.ref(`debates/${currentDebateId}/rounds/${t}/votes${e}`).transaction(t=>(t||0)+1),sessionStorage.setItem(a,"true"),alert("Köszönjük a szavazatod!")}
        async function endRound(roundIndex) {
            const round = (await db.ref(`debates/${currentDebateId}/rounds/${roundIndex}`).once('value')).val();
            const state = localState; let winner = 'Döntetlen';
            if ((round.votesA || 0) > (round.votesB || 0)) winner = 'A';
            if ((round.votesB || 0) > (round.votesA || 0)) winner = 'B';
            const updates = {};
            updates[`/rounds/${roundIndex}/winner`] = winner;
            let newMarkerPosition = state.markerPosition;
            if (winner === 'A') {
                newMarkerPosition -= 30; // JAVÍTVA 20-ról 30-ra
                updates['/scoreA'] = state.scoreA + 1;
            } else if (winner === 'B') {
                newMarkerPosition += 30; // JAVÍTVA 20-ról 30-ra
                updates['/scoreB'] = state.scoreB + 1;
            }
            updates['/markerPosition'] = newMarkerPosition;
            if (newMarkerPosition <= 0) {
                updates['/gameState'] = 'FINISHED';
                updates['/winner'] = 'A';
            } else if (newMarkerPosition >= 120) {
                updates['/gameState'] = 'FINISHED';
                updates['/winner'] = 'B';
            } else {
                const nextTurn = state.nextStartingPlayer;
                updates['/gameState'] = nextTurn + '_TURN';
                updates['/turn'] = nextTurn;
                updates['/nextStartingPlayer'] = (nextTurn === 'A' ? 'B' : 'A');
            }
            dbRef.update(updates);
        }
    </script>
</body>
</html>
