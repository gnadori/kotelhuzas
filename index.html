<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vita Kötélhúzás</title>
    <style>
        :root { --blue: #007bff; --red: #dc3545; --light-blue: #e6f2ff; --light-red: #ffe6e6; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { width: 100%; max-width: 800px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 25px; text-align: center; }
        h1, h2, h3 { color: #1c1e21; }
        button { background-color: var(--blue); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        button:hover { background-color: #0056b3; }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        input[type="text"], textarea { width: calc(100% - 24px); padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; margin: 5px 0 15px 0; }
        textarea { min-height: 100px; resize: vertical; }
        .hidden { display: none !important; }
        label { display: block; text-align: left; font-weight: bold; margin-bottom: 2px; }

        /* --- KEZDŐKÉPERNYŐ --- */
        #join-screen { max-width: 450px; }
        #role-selection-view h3 { margin-top: 25px; }
        #role-buttons button { margin: 5px; width: 120px; }

        /* --- JÁTÉK KÉPERNYŐ --- */
        #game-header { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        #debate-info { font-size: 14px; color: #666; }
        #debate-code-display { font-weight: bold; background: #eee; padding: 2px 6px; border-radius: 4px; }
        .admin-badge { background-color: #ffc107; color: #333; font-size: 12px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 5px; }
        
        /* --- TÉMA SZEKCIÓ --- */
        #debate-topic-container { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 25px; text-align: left; border-left: 5px solid var(--blue); }
        #debate-topic-container h2 { margin: 0 0 15px 0; font-size: 22px; text-align: center; }
        .positions { display: flex; justify-content: space-between; gap: 20px; }
        .position-box { flex: 1; }
        .position-box h4 { margin: 0 0 5px 0; padding-bottom: 5px; border-bottom: 2px solid; }
        .position-a h4 { color: var(--blue); border-color: var(--blue); }
        .position-b h4 { color: var(--red); border-color: var(--red); }

        /* --- KÖTÉLHÚZÁS VIZUÁLIS --- */
        .tug-of-war-container { display: flex; align-items: center; justify-content: space-between; margin: 25px 0; padding: 10px; background: linear-gradient(to right, var(--light-blue), var(--light-red)); border-radius: 8px; }
        .debater-name { font-weight: bold; font-size: 20px; }
        .name-a { color: var(--blue); }
        .name-b { color: var(--red); }
        .rope-track { flex-grow: 1; height: 8px; background-color: #ddd; margin: 0 20px; position: relative; border-radius: 4px; }
        #marker { width: 16px; height: 24px; background-color: #333; border-radius: 4px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 2px solid white; 
            transition: transform 1s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        
        /* --- KÖRÖK ÉS ÉRVEK --- */
        #rounds-container { margin-top: 20px; text-align: left; }
        .round { border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .round-header { font-weight: bold; margin-bottom: 15px; font-size: 18px; color: #555; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .arguments { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .argument-box { padding: 15px; border-radius: 8px; min-height: 80px; }
        .argument-a { background-color: var(--light-blue); border-left: 4px solid var(--blue); }
        .argument-b { background-color: var(--light-red); border-left: 4px solid var(--red); }
        .argument-box h4 { margin-top: 0; }
        .voting-section { margin-top: 15px; display: flex; justify-content: space-around; align-items: center; }
        .vote-btn { width: 45%; }
        #input-area { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; }
        #status-message { padding: 15px; background-color: #f8f9fa; border-radius: 8px; font-style: italic; color: #555; }
        #winner-screen { padding: 40px; }
        #winner-screen h1 { font-size: 36px; color: #28a745; }
    </style>
</head>
<body>

    <div class="container" id="main-container">
        <div id="join-screen">
            <div id="initial-view">
                <h1>Vita Kötélhúzás</h1>
                <p>Csatlakozz egy vitához a kapott kóddal, vagy hozz létre egy újat.</p>
                <label for="debate-code-input">Vita Kódja</label>
                <input type="text" id="debate-code-input" placeholder="Pl. AB12CD">
                <button id="check-code-btn">Ellenőrzés és Csatlakozás</button>
                <p>- vagy -</p>
                <button id="show-create-btn">Új Vita Létrehozása (Adminként)</button>
            </div>

            <div id="create-view" class="hidden">
                <h2>Új Vita Létrehozása</h2>
                <label for="topic-input">Vita Témája / Kérdés</label>
                <input type="text" id="topic-input" placeholder="Pl. Melyik a jobb háziállat?">
                <label for="pos-a-input">'A' oldal álláspontja</label>
                <input type="text" id="pos-a-input" placeholder="A kutya">
                <label for="pos-b-input">'B' oldal álláspontja</label>
                <input type="text" id="pos-b-input" placeholder="A macska">
                <button id="create-debate-btn">Létrehozás és Belépés Adminként</button>
                <button id="back-to-join-btn1" class="secondary">Vissza</button>
            </div>

            <div id="role-selection-view" class="hidden">
                <h3>Válassz Szerepkört!</h3>
                <div id="role-buttons"></div>
                <button id="back-to-join-btn2" class="secondary" style="margin-top:20px;">Vissza</button>
            </div>
        </div>

        <div id="game-screen" class="hidden">
            <div id="debate-topic-container">
                <h2 id="topic-display"></h2>
                <div class="positions">
                    <div class="position-box position-a"><h4>'A' álláspont</h4><p id="pos-a-display"></p></div>
                    <div class="position-box position-b"><h4>'B' álláspont</h4><p id="pos-b-display"></p></div>
                </div>
            </div>

            <div id="game-header">
                <h2 id="turn-indicator"></h2>
                <div id="debate-info">
                    Vita kódja: <span id="debate-code-display"></span> | Szereped: <span id="user-role-display"></span>
                    <span id="admin-badge-display" class="hidden"><span class="admin-badge">ADMIN</span></span>
                </div>
            </div>

            <div class="tug-of-war-container">
                <span class="debater-name name-a">A oldal (<span id="score-a">0</span>)</span>
                <div class="rope-track"><div id="marker"></div></div>
                <span class="debater-name name-b">(<span id="score-b">0</span>) B oldal</span>
            </div>
            <div id="rounds-container"></div>
            <div id="input-area"></div>
        </div>

        <div id="winner-screen" class="hidden"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // FIREBASE KONFIGURÁCIÓ
        const firebaseConfig = {
          apiKey: "AIzaSyBGmSIw623DYSMyvULld3cg9NznPgdOawU",
          authDomain: "kotelhuzas-c552c.firebaseapp.com",
          databaseURL: "https://kotelhuzas-c552c-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "kotelhuzas-c552c",
          storageBucket: "kotelhuzas-c552c.appspot.com",
          messagingSenderId: "847078215867",
          appId: "1:847078215867:web:a0bca5d972d117d000599e",
          measurementId: "G-F9M0EJZ4GW"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // DOM Elemek és Globális Változók
        const joinScreen=document.getElementById("join-screen"),gameScreen=document.getElementById("game-screen"),winnerScreen=document.getElementById("winner-screen"),initialView=document.getElementById("initial-view"),createView=document.getElementById("create-view"),roleSelectionView=document.getElementById("role-selection-view"),debateCodeInput=document.getElementById("debate-code-input"),checkCodeBtn=document.getElementById("check-code-btn"),showCreateBtn=document.getElementById("show-create-btn"),createDebateBtn=document.getElementById("create-debate-btn"),backBtn1=document.getElementById("back-to-join-btn1"),backBtn2=document.getElementById("back-to-join-btn2"),roleButtonsContainer=document.getElementById("role-buttons"),topicDisplay=document.getElementById("topic-display"),posADisplay=document.getElementById("pos-a-display"),posBDisplay=document.getElementById("pos-b-display"),debateCodeDisplay=document.getElementById("debate-code-display"),userRoleDisplay=document.getElementById("user-role-display"),scoreADisplay=document.getElementById("score-a"),scoreBDisplay=document.getElementById("score-b"),marker=document.getElementById("marker"),turnIndicator=document.getElementById("turn-indicator"),roundsContainer=document.getElementById("rounds-container"),inputArea=document.getElementById("input-area"),adminBadgeDisplay=document.getElementById("admin-badge-display");
        
        let currentDebateId=null,currentUserRole=null,dbRef=null,localState={};
        
        // EGYEDI FELHASZNÁLÓI AZONOSÍTÓ
        let userUid = sessionStorage.getItem('userUid');
        if (!userUid) {
            userUid = 'user_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('userUid', userUid);
        }

        // --- KEZDŐKÉPERNYŐ LOGIKA ---
        showCreateBtn.addEventListener('click', () => { initialView.classList.add('hidden'); createView.classList.remove('hidden'); });
        checkCodeBtn.addEventListener('click', checkDebateCode);
        createDebateBtn.addEventListener('click', createDebate);
        backBtn1.addEventListener('click', () => { createView.classList.add('hidden'); initialView.classList.remove('hidden'); });
        backBtn2.addEventListener('click', () => { roleSelectionView.classList.add('hidden'); initialView.classList.remove('hidden'); });

        function generateDebateCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let code = '';
            for (let i = 0; i < 6; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            return code;
        }

        async function createDebate() {
            const topic = document.getElementById('topic-input').value.trim();
            const posA = document.getElementById('pos-a-input').value.trim();
            const posB = document.getElementById('pos-b-input').value.trim();
            if (!topic || !posA || !posB) { alert('Minden mezőt ki kell tölteni!'); return; }
            
            const debateId = generateDebateCode();
            dbRef = db.ref('debates/' + debateId);
            
            // A LÉTREHOZÓ (TANÁR) ADMIN ÉS NÉZŐ LESZ
            currentUserRole = 'Néző';
            currentDebateId = debateId;

            const newDebateState = {
                topic: topic, positionA: posA, positionB: posB,
                gameState: 'WAITING_FOR_PLAYERS', // Új kezdeti állapot
                scoreA: 0, scoreB: 0, turn: 'A',
                participants: {}, // A vitázók még nem csatlakoztak
                adminUid: userUid,
                rounds: []
            };
            await dbRef.set(newDebateState);
            
            sessionStorage.setItem('debateId', currentDebateId);
            sessionStorage.setItem('userRole', currentUserRole);
            joinScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            listenForUpdates();
        }

        async function checkDebateCode() {
            const debateId = debateCodeInput.value.trim().toUpperCase();
            if (!debateId) { alert('Kérlek, adj meg egy vita kódot!'); return; }
            
            dbRef = db.ref('debates/' + debateId);
            const snapshot = await dbRef.once('value');
            if (!snapshot.exists()) { alert('Nincs ilyen kódú vita!'); return; }
            
            currentDebateId = debateId;
            const participants = snapshot.val().participants || {};
            showRoleSelection(participants);
        }

        function showRoleSelection(participants) {
            initialView.classList.add('hidden');
            createView.classList.add('hidden');
            roleSelectionView.classList.remove('hidden');
            roleButtonsContainer.innerHTML = '';

            if (!participants.A) { roleButtonsContainer.innerHTML += `<button onclick="selectRole('A')">'A' Vitázó</button>`; }
            if (!participants.B) { roleButtonsContainer.innerHTML += `<button onclick="selectRole('B')">'B' Vitázó</button>`; }
            roleButtonsContainer.innerHTML += `<button onclick="selectRole('Néző')">Néző</button>`;
        }
        
        async function selectRole(role) {
            currentUserRole = role;
            // A "Néző" szerepkört nem kell külön elmenteni a participants alá, hogy többen is lehessenek.
            if (role === 'A' || role === 'B') {
                await db.ref(`debates/${currentDebateId}/participants/${currentUserRole}`).set(true);
            }
            sessionStorage.setItem('debateId', currentDebateId);
            sessionStorage.setItem('userRole', currentUserRole);
            joinScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            listenForUpdates();
        }

        // --- FŐ JÁTÉK LOGIKA ---
        function listenForUpdates() {
            dbRef.on('value', (snapshot) => {
                if (!snapshot.exists()) { alert('A vitát törölték.'); location.reload(); return; }
                const state = snapshot.val();
                if (state.gameState === 'WAITING_FOR_PLAYERS' && state.participants?.A && state.participants?.B) {
                    dbRef.update({ gameState: 'A_TURN', turn: 'A' });
                    return;
                }
                localState = state;
                updateUI(localState);
            });
        }
        
        function updateUI(state) {
            topicDisplay.textContent = state.topic;
            posADisplay.textContent = state.positionA;
            posBDisplay.textContent = state.positionB;
            debateCodeDisplay.textContent = currentDebateId;
            userRoleDisplay.textContent = currentUserRole;
            scoreADisplay.textContent = state.scoreA;
            scoreBDisplay.textContent = state.scoreB;

            if (userUid === state.adminUid) { adminBadgeDisplay.classList.remove('hidden'); }

            const scoreDiff = state.scoreA - state.scoreB;
            const maxMove = 45;
            marker.style.transform = `translate(-50%, -50%) translateX(${scoreDiff * (maxMove / 3)}%)`;

            roundsContainer.innerHTML = '';
            if (state.rounds) {
                state.rounds.forEach((round, index) => {
                    const roundEl = document.createElement('div'); roundEl.className = 'round';
                    let roundWinnerInfo = round.winner ? ` - A kört nyerte: ${round.winner}` : '';
                    roundEl.innerHTML = `<div class="round-header">${index + 1}. Kör${roundWinnerInfo}</div><div class="arguments"><div class="argument-box argument-a"><h4>'A' érve:</h4><p>${round.argumentA || '<i>Várakozás...</i>'}</p></div><div class="argument-box argument-b"><h4>'B' érve:</h4><p>${round.argumentB || '<i>Várakozás...</i>'}</p></div></div>`;
                    
                    if (state.gameState === 'VOTING' && state.rounds.length - 1 === index) {
                        const votingSection = document.createElement('div'); votingSection.className = 'voting-section';
                        votingSection.innerHTML = `<span>Szavazz:</span><button class="vote-btn" onclick="castVote(${index}, 'A')">'A' érvére (${round.votesA || 0})</button><button class="vote-btn" onclick="castVote(${index}, 'B')">'B' érvére (${round.votesB || 0})</button>`;
                        roundEl.appendChild(votingSection);
                    }
                    
                    if (userUid === state.adminUid && state.gameState === 'VOTING' && state.rounds.length - 1 === index) {
                         const endRoundBtn = document.createElement('button'); endRoundBtn.textContent = 'Kör lezárása és eredmény (Admin)'; endRoundBtn.style.marginTop = '15px'; endRoundBtn.onclick = () => endRound(index);
                         roundEl.appendChild(endRoundBtn);
                    }
                    roundsContainer.prepend(roundEl);
                });
            }

            inputArea.innerHTML = '';
            if (state.gameState === 'FINISHED') {
                gameScreen.classList.add('hidden'); winnerScreen.classList.remove('hidden');
                winnerScreen.innerHTML = `<h1>A játék véget ért!</h1><h2>A győztes: ${state.winner} oldal!</h2><button onclick="location.reload()">Új játék</button>`;
                dbRef.off(); return;
            }

            if (state.gameState === 'WAITING_FOR_PLAYERS') {
                turnIndicator.textContent = "Várakozás a vitázók csatlakozására...";
                inputArea.innerHTML = `<div id="status-message">A vita elindul, amint 'A' és 'B' is csatlakozott.</div>`;
            } else if (state.turn === currentUserRole) {
                turnIndicator.textContent = 'Te következel!';
                const placeholder = currentUserRole === 'A' ? 'Írd be az érvedet...' : 'Írd be a válaszod...';
                inputArea.innerHTML = `<textarea id="argument-input" placeholder="${placeholder}"></textarea><button id="submit-argument-btn">Érv elküldése</button>`;
                document.getElementById('submit-argument-btn').onclick = submitArgument;
            } else if (state.gameState === 'VOTING') {
                turnIndicator.textContent = "Szavazás!";
                inputArea.innerHTML = `<div id="status-message">A közönség szavaz! Az admin lezárhatja a kört.</div>`;
            } else {
                turnIndicator.textContent = `Várakozás '${state.turn}' vitázóra...`;
                inputArea.innerHTML = `<div id="status-message">Kis türelmet, amíg a másik fél megfogalmazza az érvét.</div>`;
            }
        }
        
        function submitArgument() {
            const text = document.getElementById('argument-input').value.trim();
            if (!text) { alert('Az érv nem lehet üres!'); return; }
            const updates = {};
            if (currentUserRole === 'A') {
                const currentRoundIndex = localState.rounds ? localState.rounds.length : 0;
                updates[`/rounds/${currentRoundIndex}`] = { argumentA: text, votesA: 0, votesB: 0 };
                updates['/turn'] = 'B'; updates['/gameState'] = 'B_TURN';
            } else {
                const lastRoundIndex = localState.rounds.length - 1;
                updates[`/rounds/${lastRoundIndex}/argumentB`] = text;
                updates['/gameState'] = 'VOTING'; updates['/turn'] = null;
            }
            dbRef.update(updates);
        }
        
        function castVote(roundIndex, side) {
            db.ref(`debates/${currentDebateId}/rounds/${roundIndex}/votes${side}`).transaction((currentVotes) => (currentVotes || 0) + 1);
            alert('Köszönjük a szavazatod!');
            document.querySelectorAll('.vote-btn').forEach(b => b.disabled = true);
        }
        
        async function endRound(roundIndex) {
            const round = (await db.ref(`debates/${currentDebateId}/rounds/${roundIndex}`).once('value')).val();
            const state = localState; let winner = 'Döntetlen';
            if ((round.votesA || 0) > (round.votesB || 0)) winner = 'A';
            if ((round.votesB || 0) > (round.votesA || 0)) winner = 'B';
            const updates = {}; updates[`/rounds/${roundIndex}/winner`] = winner;
            let newScoreA = state.scoreA + (winner === 'A' ? 1 : 0);
            let newScoreB = state.scoreB + (winner === 'B' ? 1 : 0);
            updates['/scoreA'] = newScoreA; updates['/scoreB'] = newScoreB;
            if (newScoreA >= 3) { updates['/gameState'] = 'FINISHED'; updates['/winner'] = 'A'; } 
            else if (newScoreB >= 3) { updates['/gameState'] = 'FINISHED'; updates['/winner'] = 'B'; } 
            else { updates['/gameState'] = 'A_TURN'; updates['/turn'] = 'A'; }
            dbRef.update(updates);
        }

        (function restoreSession() {
            const savedDebateId = sessionStorage.getItem('debateId');
            const savedUserRole = sessionStorage.getItem('userRole');
            if (savedDebateId && savedUserRole) {
                currentDebateId = savedDebateId; currentUserRole = savedUserRole;
                dbRef = db.ref('debates/' + savedDebateId);
                joinScreen.classList.add('hidden'); gameScreen.classList.remove('hidden');
                listenForUpdates();
            }
        })();
    </script>
</body>
</html>
