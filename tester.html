<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vita Kötélhúzás (Debug)</title>
    <style>body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background-color:#f0f2f5;color:#333;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;margin:0;padding:20px;box-sizing:border-box}.container{width:100%;max-width:800px;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1);padding:25px;text-align:center}h1,h2{color:#1c1e21}button{background-color:#007bff;color:#fff;border:none;padding:12px 20px;border-radius:8px;font-size:16px;cursor:pointer;transition:background-color .2s}button:hover{background-color:#0056b3}button:disabled{background-color:#ccc;cursor:not-allowed}input[type=text],textarea{width:calc(100% - 24px);padding:12px;border:1px solid #ddd;border-radius:8px;font-size:16px;margin-bottom:10px}textarea{min-height:100px;resize:vertical}.hidden{display:none!important}#join-screen{max-width:400px}#game-header{margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #eee}#debate-info{font-size:14px;color:#666}#debate-code-display{font-weight:700;background:#eee;padding:2px 6px;border-radius:4px}.tug-of-war-container{display:flex;align-items:center;justify-content:space-between;margin:25px 0;padding:10px;background:linear-gradient(to right,#e6f2ff,#ffe6e6);border-radius:8px}.debater-name{font-weight:700;font-size:20px}.name-a{color:#0056b3}.name-b{color:#b30000}.rope-track{flex-grow:1;height:8px;background-color:#ddd;margin:0 20px;position:relative;border-radius:4px}#marker{width:16px;height:24px;background-color:#333;border-radius:4px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);transition:transform .5s ease-in-out;border:2px solid #fff}#rounds-container{margin-top:20px;text-align:left}.round{border:1px solid #eee;border-radius:8px;padding:15px;margin-bottom:15px}.round-header{font-weight:700;margin-bottom:15px;font-size:18px;color:#555;padding-bottom:10px;border-bottom:1px solid #eee}.arguments{display:grid;grid-template-columns:1fr 1fr;gap:15px}.argument-box{padding:15px;border-radius:8px;min-height:80px}.argument-a{background-color:#e6f2ff;border-left:4px solid #007bff}.argument-b{background-color:#ffe6e6;border-left:4px solid #dc3545}.argument-box h4{margin-top:0}.voting-section{margin-top:15px;display:flex;justify-content:space-around;align-items:center}.vote-btn{width:45%}#input-area{margin-top:30px;padding-top:20px;border-top:1px solid #eee}#status-message{padding:15px;background-color:#f8f9fa;border-radius:8px;font-style:italic;color:#555}#winner-screen{padding:40px}#winner-screen h1{font-size:36px;color:#28a745}</style>
</head>
<body>
    <div class="container" id="main-container"><div id="join-screen"><h1>Vita Kötélhúzás</h1><p>Hozd létre a saját vitádat, vagy csatlakozz egy meglévőhöz a kapott kóddal.</p><input type="text" id="debate-code-input" placeholder="Vita kódja (hagyd üresen újhoz)"><button id="join-btn">Létrehozás / Csatlakozás</button></div><div id="game-screen" class="hidden"><div id="game-header"><h2 id="turn-indicator">A játék betöltése...</h2><div id="debate-info">Vita kódja: <span id="debate-code-display"></span> | Szereped: <span id="user-role-display"></span></div></div><div class="tug-of-war-container"><span class="debater-name name-a">A oldal (<span id="score-a">0</span>)</span><div class="rope-track"><div id="marker"></div></div><span class="debater-name name-b">(<span id="score-b">0</span>) B oldal</span></div><div id="rounds-container"></div><div id="input-area"></div></div><div id="winner-screen" class="hidden"><h1>A játék véget ért!</h1><h2 id="winner-message"></h2><button onclick="location.reload()">Új játék</button></div></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // =================================================================================
        // FIREBASE KONFIGURÁCIÓ
        // =================================================================================
        const firebaseConfig = {
          apiKey: "AIzaSyBGmSIw623DYSMyvULld3cg9NznPgdOawU",
          authDomain: "kotelhuzas-c552c.firebaseapp.com",
          databaseURL: "https://kotelhuzas-c552c-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "kotelhuzas-c552c",
          storageBucket: "kotelhuzas-c552c.appspot.com",
          messagingSenderId: "847078215867",
          appId: "1:847078215867:web:a0bca5d972d117d000599e",
          measurementId: "G-F9M0EJZ4GW"
        };
        // =================================================================================

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // DOM elemek és globális változók...
        const joinScreen=document.getElementById("join-screen"),gameScreen=document.getElementById("game-screen"),winnerScreen=document.getElementById("winner-screen"),joinBtn=document.getElementById("join-btn"),debateCodeInput=document.getElementById("debate-code-input"),debateCodeDisplay=document.getElementById("debate-code-display"),userRoleDisplay=document.getElementById("user-role-display"),scoreADisplay=document.getElementById("score-a"),scoreBDisplay=document.getElementById("score-b"),marker=document.getElementById("marker"),turnIndicator=document.getElementById("turn-indicator"),roundsContainer=document.getElementById("rounds-container"),inputArea=document.getElementById("input-area"),winnerMessage=document.getElementById("winner-message");
        let currentDebateId=null,currentUserRole=null,dbRef=null,localState={};

        joinBtn.addEventListener('click', joinOrCreateDebate);

        function generateDebateCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            return code;
        }

        async function joinOrCreateDebate() {
            console.log("--- Létrehozás/csatlakozás gomb lenyomva ---");
            let debateId = debateCodeInput.value.trim().toUpperCase();
            
            if (!debateId) {
                debateId = generateDebateCode();
                currentUserRole = 'A';
                console.log(`Új vita létrehozása. Kód: ${debateId}, Szerep: ${currentUserRole}`);
                
                const newDebateState = {
                    gameState: 'WAITING_FOR_B', scoreA: 0, scoreB: 0, turn: 'A',
                    participants: { A: true }, rounds: []
                };
                
                dbRef = db.ref('debates/' + debateId);
                await dbRef.set(newDebateState);
            } else {
                dbRef = db.ref('debates/' + debateId);
                const snapshot = await dbRef.once('value');
                if (!snapshot.exists()) {
                    alert('Nincs ilyen kódú vita!');
                    console.error("Nem létező vita kód:", debateId);
                    return;
                }
                
                const participants = snapshot.val().participants || {};
                
                if (!participants.A) currentUserRole = 'A';
                else if (!participants.B) currentUserRole = 'B';
                else currentUserRole = 'Néző';
                console.log(`Csatlakozás meglévő vitához. Kód: ${debateId}, Szerep: ${currentUserRole}`);

                await db.ref(`debates/${debateId}/participants/${currentUserRole}`).set(true);
            }
            
            currentDebateId = debateId;
            sessionStorage.setItem('debateId', currentDebateId);
            sessionStorage.setItem('userRole', currentUserRole);

            joinScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            
            listenForUpdates();
        }

        function listenForUpdates() {
            console.log("Figyelő (listener) elindítva.");
            dbRef.on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    alert('A vitát törölték.');
                    location.reload();
                    return;
                }
                
                const state = snapshot.val();
                console.log("%cFigyelő lefutott. Jelenlegi állapot az adatbázisból:", "color: blue; font-weight: bold;", state);

                if (state.gameState === 'WAITING_FOR_B' && state.participants?.A && state.participants?.B) {
                    console.log("%cFELTÉTEL TELJESÜLT: Mindkét játékos bent van. Játék indítása...", "color: green; font-weight: bold;");
                    dbRef.update({ gameState: 'A_TURN', turn: 'A' });
                    return;
                }

                localState = state;
                updateUI(localState);
            });
        }

        function updateUI(state) {
            console.log("updateUI() funkció meghívva ezzel az állapottal:", state.gameState);
            // A UI frissítő kód többi része változatlan...
            debateCodeDisplay.textContent=currentDebateId;userRoleDisplay.textContent=currentUserRole;scoreADisplay.textContent=state.scoreA;scoreBDisplay.textContent=state.scoreB;const t=state.scoreA-state.scoreB;marker.style.transform=`translate(-50%, -50%) translateX(${t*15}%)`;roundsContainer.innerHTML="";if(state.rounds){state.rounds.forEach((t,e)=>{const o=document.createElement("div");o.className="round";let n=t.winner?` - A kört nyerte: ${t.winner}`:"";o.innerHTML=`\n                        <div class="round-header">${e+1}. Kör${n}</div>\n                        <div class="arguments">\n                            <div class="argument-box argument-a"><h4>'A' érve:</h4><p>${t.argumentA||"<i>Várakozás...</i>"}</p></div>\n                            <div class="argument-box argument-b"><h4>'B' érve:</h4><p>${t.argumentB||"<i>Várakozás...</i>"}</p></div>\n                        </div>\n                    `;if("VOTING"===state.gameState&&state.rounds.length-1===e){const t=document.createElement("div");t.className="voting-section",t.innerHTML=`\n                            <span>Szavazz:</span>\n                            <button class="vote-btn" onclick="castVote(${e}, 'A')">'A' érvére (${t.votesA||0})</button>\n                            <button class="vote-btn" onclick="castVote(${e}, 'B')">'B' érvére (${t.votesB||0})</button>\n                        `,o.appendChild(t)}("A"===currentUserRole||"B"===currentUserRole)&&"VOTING"===state.gameState&&state.rounds.length-1===e&&(()=>{const t=document.createElement("button");t.textContent="Kör lezárása és eredmény",t.style.marginTop="15px",t.onclick=()=>endRound(e),o.appendChild(t)})(),roundsContainer.prepend(o)})}inputArea.innerHTML="";if("FINISHED"===state.gameState)return gameScreen.classList.add("hidden"),winnerScreen.classList.remove("hidden"),winnerMessage.textContent=`A győztes: ${state.winner} oldal!`,void dbRef.off();"WAITING_FOR_B"===state.gameState?(turnIndicator.textContent="Várakozás 'B' vitázóra...",inputArea.innerHTML='<div id="status-message">Amint \'B\' csatlakozik, \'A\' kezdheti az első kört.</div>'):state.turn===currentUserRole?(turnIndicator.textContent="Te következel!",inputArea.innerHTML=`\n                    <textarea id="argument-input" placeholder="${"A"===currentUserRole?"Írd be az érvedet...":"Írd be a válaszod..."}"></textarea>\n                    <button id="submit-argument-btn">Érv elküldése</button>\n                `,document.getElementById("submit-argument-btn").onclick=submitArgument):"VOTING"===state.gameState?(turnIndicator.textContent="Szavazás!",inputArea.innerHTML='<div id="status-message">A közönség szavaz! A vitázók a \'Kör lezárása\' gombbal léphetnek tovább.</div>'):(turnIndicator.textContent=`Várakozás '${state.turn}' vitázóra...`,inputArea.innerHTML='<div id="status-message">Kis türelmet, amíg a másik fél megfogalmazza az érvét.</div>')
        }
        
        // A többi funkció (submit, vote, endRound, restoreSession) változatlan...
        function submitArgument(){const t=document.getElementById("argument-input").value.trim();if(!t)return void alert("Az érv nem lehet üres!");const e={};"A"===currentUserRole?(e[`/rounds/${localState.rounds?localState.rounds.length:0}`]={argumentA:t,votesA:0,votesB:0},e["/turn"]="B",e["/gameState"]="B_TURN"):(e[`/rounds/${localState.rounds.length-1}/argumentB`]=t,e["/gameState"]="VOTING",e["/turn"]=null),dbRef.update(e)}function castVote(t,e){db.ref(`debates/${currentDebateId}/rounds/${t}/votes${e}`).transaction(t=>(t||0)+1),alert("Köszönjük a szavazatod!"),document.querySelectorAll(".vote-btn").forEach(t=>t.disabled=!0)}async function endRound(t){const e=(await db.ref(`debates/${currentDebateId}/rounds/${t}`).once("value")).val(),o=localState;let n="Döntetlen";(e.votesA||0)>(e.votesB||0)&&(n="A"),(e.votesB||0)>(e.votesA||0)&&(n="B");const a={};a[`/rounds/${t}/winner`]=n;let s=o.scoreA+("A"===n?1:0),r=o.scoreB+("B"===n?1:0);a["/scoreA"]=s,a["/scoreB"]=r,s>=3?(a["/gameState"]="FINISHED",a["/winner"]="A"):r>=3?(a["/gameState"]="FINISHED",a["/winner"]="B"):(a["/gameState"]="A_TURN",a["/turn"]="A"),dbRef.update(a)}!function(){const t=sessionStorage.getItem("debateId"),e=sessionStorage.getItem("userRole");t&&e&&(currentDebateId=t,currentUserRole=e,dbRef=db.ref("debates/"+currentDebateId),joinScreen.classList.add("hidden"),gameScreen.classList.remove("hidden"),listenForUpdates())}();
    </script>
</body>
</html>
